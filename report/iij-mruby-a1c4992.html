<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>mruby build & test report</title>
    <style>
      pre {
        white-space: -moz-pre-wrap; /* Mozilla */
        white-space: -pre-wrap;     /* Opera 4-6 */
        white-space: -o-pre-wrap;   /* Opera 7 */
        white-space: pre-wrap;      /* CSS3 */
        word-wrap: break-word;      /* IE 5.5+ */
      }
      textarea {
        width: 100%;
        height: 400px;
        font-family: monospace !important;
        font-size: 12px !important;
      }
    </style>
  </head>
  <body>
    <a name="top"></a>
    <div style="background-color:#a0a0a0;">
      
        
        <a href="mruby-mruby.html">mruby-mruby</a>
      
        
        <a href="iij-mruby.html">iij-mruby</a>
      
    </div>

    
    

    <h1>mruby build & test report
      <span style="font-size:small;">(iij/mruby - a1c4992)</span>
    </h1>

    <ul>
      <li><a href="http://github.com/iij/mruby/commit/a1c4992" target="_blank">commit info on github</a></li>
      
      
        
        
        
          <li><a href="iij-mruby.html">back to iij-mruby</a></li>
        
      
      <li>
      <pre>commit a1c4992905e6e3df1e6841085c552b33cf525b0f
Author: Yuichiro MASUI &lt;masui@masuidrive.jp&gt;
Date:   Mon Jan 21 22:15:15 2013 +0900

    Added flags_before_libraries to linker

</pre>
      <a href="#commitlog">commit log</a>
      </li>
  </ul>

    <h2>mrbtest</h2>
    <table border="1">
      <tr>
        
          <th>Name</th>
        
          <th>Build-Status</th>
        
          <th>Mrbtest-Status</th>
        
          <th>Total</th>
        
          <th>OK</th>
        
          <th>KO</th>
        
          <th>Crash</th>
        
          <th>Fail</th>
        
          <th>Msg</th>
        
      </tr>
      
        
        
        <tr style="background-color:#99ff99">
          <td><a href="#netbsd_arm">netbsd_arm</a></td>
          <td>success</td>
          <td>success</td>
          <td>515</td>
          <td>515</td>
          <td>0</td>
          <td>0</td>
          <td></td>
          <td></td>
        </tr>
      
    </table>

    

    <h2>environment <span style="font-size:small;"><a href="#top">#top</a></span></h2>
    <table border='1'>
      <tr>
        <th>Name</th>
        <th>software version</th>
      </tr>
      
        
        <tr>
          <td rowspan="3">netbsd_arm</td>
          <td><b>gcc</b><br/><pre></pre></td>
        </tr>
        <tr><td><b>make</b><br/><pre></pre></td></tr>
        <tr><td><b>bison</b><br/><pre></pre></td></tr>
      
    </table>

    <h2>Build Log</h2>
    
      
      <h3><a name="netbsd_arm">netbsd_arm</a> <span style="font-size:small;"><a href="#top">#top</a></span></h3>
      <table border='1' style="width:90%;">
        <tr>
          <th style="width:100px;">task</th>
          <th>stdout</th>
          <th>stderr</th>
        </tr>
        <tr>
          <th>make</th>
          <td><textarea>(in /home/mruby/arm/iij-mruby-a1c4992)
CC "tools/mruby/mruby.c" > "build/host/tools/mruby/mruby.o"
CC "src/range.c" > "build/host/src/range.o"
CC "src/array.c" > "build/host/src/array.o"
CC "src/numeric.c" > "build/host/src/numeric.o"
CC "src/pool.c" > "build/host/src/pool.o"
CC "src/compar.c" > "build/host/src/compar.o"
CC "src/crc.c" > "build/host/src/crc.o"
CC "src/regcomp.c" > "build/host/src/regcomp.o"
CC "src/proc.c" > "build/host/src/proc.o"
CC "src/math.c" > "build/host/src/math.o"
CC "src/state.c" > "build/host/src/state.o"
CC "src/print.c" > "build/host/src/print.o"
CC "src/vm.c" > "build/host/src/vm.o"
CC "src/class.c" > "build/host/src/class.o"
CC "src/load.c" > "build/host/src/load.o"
CC "src/codegen.c" > "build/host/src/codegen.o"
CC "src/symbol.c" > "build/host/src/symbol.o"
CC "src/etc.c" > "build/host/src/etc.o"
CC "src/gc.c" > "build/host/src/gc.o"
CC "src/st.c" > "build/host/src/st.o"
CC "src/struct.c" > "build/host/src/struct.o"
CC "src/regerror.c" > "build/host/src/regerror.o"
CC "src/regparse.c" > "build/host/src/regparse.o"
CC "src/init.c" > "build/host/src/init.o"
CC "src/regexec.c" > "build/host/src/regexec.o"
CC "src/dump.c" > "build/host/src/dump.o"
CC "src/kernel.c" > "build/host/src/kernel.o"
CC "src/hash.c" > "build/host/src/hash.o"
CC "src/string.c" > "build/host/src/string.o"
CC "src/sprintf.c" > "build/host/src/sprintf.o"
CC "src/variable.c" > "build/host/src/variable.o"
CC "src/object.c" > "build/host/src/object.o"
CC "src/cdump.c" > "build/host/src/cdump.o"
CC "src/time.c" > "build/host/src/time.o"
CC "src/regenc.c" > "build/host/src/regenc.o"
CC "src/enum.c" > "build/host/src/enum.o"
CC "src/error.c" > "build/host/src/error.o"
CC "src/init_ext.c" > "build/host/src/init_ext.o"
CC "src/re.c" > "build/host/src/re.o"
YACC "src/parse.y" > "build/host/src/y.tab.c"
CC "build/host/src/y.tab.c" > "build/host/src/y.tab.o"
CC "tools/mrbc/mrbc.c" > "build/host/tools/mrbc/mrbc.o"
AR "build/host/lib/libmruby_core.a"
LD "build/host/bin/mrbc"
GEN *.rb > build/host/mrblib/mrblib.c
  MRBC mrblib/kernel.rb
  MRBC mrblib/compar.rb
  MRBC mrblib/hash.rb
  MRBC mrblib/numeric.rb
  MRBC mrblib/class.rb
  MRBC mrblib/string.rb
  MRBC mrblib/enum.rb
  MRBC mrblib/print.rb
  MRBC mrblib/array.rb
  MRBC mrblib/range.rb
  MRBC mrblib/error.rb
  MRBC mrblib/struct.rb
CC "build/host/mrblib/mrblib.c" > "build/host/mrblib/mrblib.o"
AR "build/host/lib/libmruby.a"
LD "build/host/bin/mruby"
CC "tools/mirb/mirb.c" > "build/host/tools/mirb/mirb.o"
LD "build/host/bin/mirb"
</textarea></td>
          <td><textarea>ar: creating build/host/lib/libmruby_core.a
ar: creating build/host/lib/libmruby.a
</textarea></td>
        </tr>
        <tr>
          <th>make test</th>
          <td><textarea>(in /home/mruby/arm/iij-mruby-a1c4992)
CC "test/driver.c" > "build/host/test/driver.o"
GEN *.rb > build/host/test/mrbtest.c
  MRBC test/assert.rb
  MRBC test/t/module.rb
  MRBC test/t/math.rb
  MRBC test/t/kernel.rb
  MRBC test/t/integer.rb
  MRBC test/t/gc.rb
  MRBC test/t/standarderror.rb
  MRBC test/t/basicobject.rb
  MRBC test/t/object.rb
  MRBC test/t/hash.rb
  MRBC test/t/comparable.rb
  MRBC test/t/exception.rb
  MRBC test/t/numeric.rb
  MRBC test/t/bs_literal.rb
  MRBC test/t/false.rb
  MRBC test/t/float.rb
  MRBC test/t/class.rb
  MRBC test/t/nomethoderror.rb
  MRBC test/t/true.rb
  MRBC test/t/nil.rb
  MRBC test/t/rangeerror.rb
  MRBC test/t/typeerror.rb
  MRBC test/t/proc.rb
  MRBC test/t/literals.rb
  MRBC test/t/indexerror.rb
  MRBC test/t/nameerror.rb
  MRBC test/t/bs_block.rb
  MRBC test/t/regexperror.rb
  MRBC test/t/string.rb
  MRBC test/t/argumenterror.rb
  MRBC test/t/runtimeerror.rb
  MRBC test/t/array.rb
  MRBC test/t/range.rb
  MRBC test/t/syntax.rb
  MRBC test/t/localjumperror.rb
  MRBC test/t/struct.rb
  MRBC test/t/symbol.rb
  MRBC test/t/enumerable.rb
  MRBC test/t/time.rb
CC "build/host/test/mrbtest.c" > "build/host/test/mrbtest.o"
LD "build/host/test/mrbtest"
>>> Test host <<<
mrbtest - Embeddable Ruby Test

This is a very early version, please test and report errors.
Thanks :)

...................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
Total: 515
   OK: 515
   KO: 0
Crash: 0
 Time: 36.260021 seconds

</textarea></td>
          <td><textarea></textarea></td>
        </tr>
        
      </table>
    

    <h2><a name="commitlog">commit log</a> <span style="font-size:small;"><a href="#top">#top</a></span></h2>
      <pre>commit a1c4992905e6e3df1e6841085c552b33cf525b0f
Author: Yuichiro MASUI &lt;masui@masuidrive.jp&gt;
Date:   Mon Jan 21 22:15:15 2013 +0900

    Added flags_before_libraries to linker

diff --git a/build_config.rb b/build_config.rb
index 1c177fd..1eeff4b 100644
--- a/build_config.rb
+++ b/build_config.rb
@@ -29,6 +29,7 @@ MRuby::Build.new do |conf|
   # conf.linker do |linker|
   #   linker.command = ENV['LD'] || 'gcc'
   #   linker.flags = [ENV['LDFLAGS'] || []]
+  #   linker.flags_before_libraries = []
   #   linker.libraries = %w()
   #   linker.library_paths = []
   #   linker.option_library = '-l%s'
diff --git a/doc/compile/README.md b/doc/compile/README.md
index a1c915a..05d5606 100644
--- a/doc/compile/README.md
+++ b/doc/compile/README.md
@@ -118,6 +118,7 @@ Configuration of the Linker binary, flags and library paths.
 conf.linker do |linker|
   linker.command = ...
   linker.flags = ...
+  linker.flags_before_libraries = ...
   linker.libraries = ...
   linker.library_paths = ....
   linker.option_library = ...
diff --git a/tasks/libmruby.rake b/tasks/libmruby.rake
index 108f42f..4cfebac 100644
--- a/tasks/libmruby.rake
+++ b/tasks/libmruby.rake
@@ -2,14 +2,17 @@ MRuby.each_target do
   file libfile(&quot;#{build_dir}/lib/libmruby&quot;) =&gt; libmruby.flatten do |t|
     archiver.run t.name, t.prerequisites
     open(&quot;#{build_dir}/lib/libmruby.flags.mak&quot;, 'w') do |f|
-      f.puts 'CFLAGS = &quot;%s&quot;' % cc.all_flags.gsub('&quot;', '\\&quot;') 
+      f.puts 'MRUBY_CFLAGS = &quot;%s&quot;' % cc.all_flags.gsub('&quot;', '\\&quot;') 
 
       gem_flags = gems.map { |g| g.linker.flags }
       gem_library_paths = gems.map { |g| g.linker.library_paths }
-      f.puts 'LDFLAGS = &quot;%s&quot;' % linker.all_flags(gem_library_paths, gem_flags).gsub('&quot;', '\\&quot;') 
+      f.puts 'MRUBY_LDFLAGS = &quot;%s&quot;' % linker.all_flags(gem_library_paths, gem_flags).gsub('&quot;', '\\&quot;') 
+
+      gem_flags_before_libraries = gems.map { |g| g.linker.flags_before_libraries }
+      f.puts 'MRUBY_LDFLAGS_BEFORE_LIBS = &quot;%s&quot;' % [linker.flags_before_libraries, gem_flags_before_libraries].flatten.join(' ').gsub('&quot;', '\\&quot;') 
 
       gem_libraries = gems.map { |g| g.linker.libraries }
-      f.puts 'LIBS = &quot;%s&quot;' % linker.library_flags(gem_libraries).gsub('&quot;', '\\&quot;') 
+      f.puts 'MRUBY_LIBS = &quot;%s&quot;' % linker.library_flags(gem_libraries).gsub('&quot;', '\\&quot;') 
     end
   end
 end
diff --git a/tasks/mrbgem_spec.rake b/tasks/mrbgem_spec.rake
index 906f47a..612ff24 100644
--- a/tasks/mrbgem_spec.rake
+++ b/tasks/mrbgem_spec.rake
@@ -6,7 +6,7 @@ module MRuby
     class &lt;&lt; self
       attr_accessor :current
     end
-    LinkerConfig = Struct.new(:libraries, :library_paths, :flags) 
+    LinkerConfig = Struct.new(:libraries, :library_paths, :flags, :flags_before_libraries) 
 
     class Specification
       include Rake::DSL
@@ -43,7 +43,7 @@ module MRuby
         MRuby::Build::COMMANDS.each do |command|
           instance_variable_set(&quot;@#{command}&quot;, @build.send(command).clone)
         end
-        @linker = LinkerConfig.new([], [], [])
+        @linker = LinkerConfig.new([], [], [], [])
 
         @rbfiles = Dir.glob(&quot;#{dir}/mrblib/*.rb&quot;)
         @objs = Dir.glob(&quot;#{dir}/src/*.{c,cpp,m,asm,S}&quot;).map do |f|
diff --git a/tasks/mruby_build_commands.rake b/tasks/mruby_build_commands.rake
index 8ffafe9..abaf3a7 100644
--- a/tasks/mruby_build_commands.rake
+++ b/tasks/mruby_build_commands.rake
@@ -48,18 +48,16 @@ module MRuby
 
     def all_flags(_defineds=[], _include_paths=[], _flags=[])
       define_flags = [defines, _defineds].flatten.map{ |d| option_define % d }
-      include_path_flags = [include_paths, _include_paths].flatten.map{ |f| option_include_path % filename(f) }
+      include_path_flags = [include_paths, _include_paths].flatten.map do |f|
+        option_include_path % filename(f)
+      end
       [flags, define_flags, include_path_flags, _flags].flatten.join(' ')
     end
     
     def run(outfile, infile, _defineds=[], _include_paths=[], _flags=[])
       FileUtils.mkdir_p File.dirname(outfile)
-      define_flags = [defines, _defineds].flatten.map{ |d| option_define % d }
-      include_path_flags = [include_paths, _include_paths, File.dirname(infile)].flatten.map do |f|
-        option_include_path % filename(f)
-      end
       _pp &quot;CC #{filename(infile)} &gt; #{filename(outfile)}&quot;
-      _run compile_options, { :flags =&gt; (flags + define_flags + include_path_flags + _flags).join(' '),
+      _run compile_options, { :flags =&gt; all_flags(_defineds, [_include_paths, File.dirname(infile)], _flags),
                               :infile =&gt; filename(infile), :outfile =&gt; filename(outfile) }
     end
 
@@ -104,36 +102,42 @@ module MRuby
   end
 
   class Command::Linker &lt; Command
-    attr_accessor :flags, :libraries, :library_paths
+    attr_accessor :flags, :flags_before_libraries, :libraries, :library_paths
     attr_accessor :link_options, :option_library, :option_library_path
 
     def initialize(build)
       super
       @command = ENV['LD'] || 'gcc'
       @flags = (ENV['LDFLAGS'] || [])
+      @flags_before_libraries = []
       @libraries = []
       @library_paths = []
       @option_library = '-l%s'
       @option_library_path = '-L%s'
-      @link_options = &quot;%{flags} -o %{outfile} %{objs} %{libs}&quot;
+      @link_options = &quot;%{flags} -o %{outfile} %{objs} %{flags_before_libraries} %{libs}&quot;
     end
 
     def all_flags(_library_paths=[], _flags=[])
-      library_path_flags = [library_paths, _library_paths].flatten.map{ |f| option_library_path % filename(f) }
+      library_path_flags = [library_paths, _library_paths].flatten.map do |f|
+        option_library_path % filename(f)
+      end
       [flags, library_path_flags, _flags].flatten.join(' ')
     end
 
     def library_flags(_libraries)
-      [libraries, _libraries].flatten.reverse.map{ |d| option_library % d }.join(' ')
+      [libraries, _libraries].flatten.reverse.map do |d|
+        option_library % d
+      end.join(' ')
     end
 
-    def run(outfile, objfiles, _libraries=[], _library_paths=[], _flags=[])
+    def run(outfile, objfiles, _libraries=[], _library_paths=[], _flags=[], _flags_before_libraries=[])
       FileUtils.mkdir_p File.dirname(outfile)
-      library_flags = [libraries, _libraries].flatten.reverse.map{ |d| option_library % d }
-      library_path_flags = [library_paths, _library_paths].flatten.map{ |f| option_library_path % filename(f) }
+      library_flags = [libraries, _libraries].flatten.reverse.map { |d| option_library % d }
+      library_path_flags = [library_paths, _library_paths].flatten.map { |f| option_library_path % filename(f) }
       _pp &quot;LD #{filename(outfile)}&quot;
-      _run link_options, { :flags =&gt; (flags + library_path_flags + _flags).join(' '),
+      _run link_options, { :flags =&gt; all_flags(_library_paths, _flags),
                            :outfile =&gt; filename(outfile) , :objs =&gt; filename(objfiles).join(' '),
+                           :flags_before_libraries =&gt; [flags_before_libraries, _flags_before_libraries].flatten.join(' '),
                            :libs =&gt; library_flags.join(' ') }
     end
   end
diff --git a/tasks/toolchains/gcc.rake b/tasks/toolchains/gcc.rake
index c624c8f..3a3485a 100644
--- a/tasks/toolchains/gcc.rake
+++ b/tasks/toolchains/gcc.rake
@@ -16,6 +16,6 @@ MRuby::Toolchain.new(:gcc) do |conf|
     linker.library_paths = []
     linker.option_library = '-l%s'
     linker.option_library_path = '-L%s'
-    linker.link_options = '%{flags} -o %{outfile} %{objs} %{libs}'
+    linker.link_options = '%{flags} -o %{outfile} %{objs} %{flags_before_libraries} %{libs}'
   end
 end
diff --git a/tasks/toolchains/vs2012.rake b/tasks/toolchains/vs2012.rake
index c3599a5..108b433 100644
--- a/tasks/toolchains/vs2012.rake
+++ b/tasks/toolchains/vs2012.rake
@@ -16,7 +16,7 @@ MRuby::Toolchain.new(:vs2012) do |conf|
     linker.library_paths = %w()
     linker.option_library = '%s'
     linker.option_library_path = '/LIBPATH:%s'
-    linker.link_options = &quot;%{flags} /OUT:%{outfile} %{objs} %{libs}&quot;
+    linker.link_options = &quot;%{flags} /OUT:%{outfile} %{objs} %{flags_before_libraries} %{libs}&quot;
   end
  
   conf.archiver do |archiver|
diff --git a/test/mrbtest.rake b/test/mrbtest.rake
index 76ddc30..30444bd 100644
--- a/test/mrbtest.rake
+++ b/test/mrbtest.rake
@@ -10,11 +10,12 @@ MRuby.each_target do
 
   objs = [objfile(&quot;#{build_dir}/#{dir}/driver&quot;), mlib].flatten
 
-  file exec =&gt; objs + gems.map(&amp;:testlib) + [libfile(&quot;#{build_dir}/lib/libmruby&quot;)] do |t|
+  file exec =&gt; objs + gems.map(&amp;:testlib).flatten + [libfile(&quot;#{build_dir}/lib/libmruby&quot;)] do |t|
     gem_flags = gems.map { |g| g.linker.flags }
+    gem_flags_before_libraries = gems.map { |g| g.linker.flags_before_libraries }
     gem_libraries = gems.map { |g| g.linker.libraries }
     gem_library_paths = gems.map { |g| g.linker.library_paths }
-    linker.run t.name, t.prerequisites, gem_libraries, gem_library_paths, gem_flags
+    linker.run t.name, t.prerequisites, gem_libraries, gem_library_paths, gem_flags, gem_flags_before_libraries
   end
 
   file mlib =&gt; [clib]
diff --git a/tools/mirb/mirb.rake b/tools/mirb/mirb.rake
index 0c340a2..dbce4f1 100644
--- a/tools/mirb/mirb.rake
+++ b/tools/mirb/mirb.rake
@@ -7,9 +7,10 @@ MRuby.each_target do
 
     file exec =&gt; objs + [libfile(&quot;#{build_dir}/lib/libmruby&quot;)] do |t|
       gem_flags = gems.map { |g| g.linker.flags }
+      gem_flags_before_libraries = gems.map { |g| g.linker.flags_before_libraries }
       gem_libraries = gems.map { |g| g.linker.libraries }
       gem_library_paths = gems.map { |g| g.linker.library_paths }
-      linker.run t.name, t.prerequisites, gem_libraries, gem_library_paths, gem_flags
+      linker.run t.name, t.prerequisites, gem_libraries, gem_library_paths, gem_flags, gem_flags_before_libraries
     end
   end
 end
diff --git a/tools/mruby/mruby.rake b/tools/mruby/mruby.rake
index df31b03..7111dc0 100644
--- a/tools/mruby/mruby.rake
+++ b/tools/mruby/mruby.rake
@@ -7,9 +7,10 @@ MRuby.each_target do
 
     file exec =&gt; objs + [libfile(&quot;#{build_dir}/lib/libmruby&quot;)] do |t|
       gem_flags = gems.map { |g| g.linker.flags }
+      gem_flags_before_libraries = gems.map { |g| g.linker.flags_before_libraries }
       gem_libraries = gems.map { |g| g.linker.libraries }
       gem_library_paths = gems.map { |g| g.linker.library_paths }
-      linker.run t.name, t.prerequisites, gem_libraries, gem_library_paths, gem_flags
+      linker.run t.name, t.prerequisites, gem_libraries, gem_library_paths, gem_flags, gem_flags_before_libraries
     end
   end
 end
</pre>

  </body>
</html>
